---
title: "An example of the survey library for R"
author: "Joshua Megnauth"
date: "June 15, 2020"
output:
  html_document:
    theme: darkly
    highlight: zenburn
    df_print: paged
---
Survey weights are both totally awesome and extremely annoying. You basically always have to account for weights because your analysis would implode without it. Certain groups, such as minorities, are oversampled to ensure they're adequately measured. Weights correct oversampling via distinguishing clusters, oversampled or undersampled groups, the percent of the total population surveyed, et cetera.

**This is wonderful!** *But also annoying.*

Your data set has hundreds of weight variables that use different metrics for weighting. I assume that I used the appropriate weights according to the documents, but at the same time I'm not entirely sure.

Anywho. You need to use the [survey](http://r-survey.r-forge.r-project.org/survey/) library unless you're manually accounting for weights.
```{r libraries, warning=FALSE, message=FALSE}
library(survey)
library(kableExtra)
library(broom)
library(tidyverse)

hints <- 
  haven::read_spss("hints5_cycle3_public.sav") %>%
  map(~ifelse(.x > 0, .x, NA)) %>%
  data.frame() %>%
  mutate(UseECigNow = as_factor(recode(UseECigNow,
                                       `1` = "Everyday",
                                       `2` = "Some days",
                                       `3` = "Not at all")),
         IncomeFeelings = as_factor(recode(IncomeFeelings,
                                           `1` = "Living comfortably",
                                           `2` = "Getting by",
                                           `3` = "Finding it difficult",
                                           `4` = "Finding it very difficult")),
         TobaccoMessages_HESmoking = as_factor(recode(TobaccoMessages_HESmoking,
                                                      `1` = "Selected",
                                                      `2` = "Not Selected")),
         SmokeNow = as_factor(recode(SmokeNow,
                                     `1` = "Everyday",
                                     `2` = "Some days",
                                     `3` = "Not at all")),
         Smoke100 = as_factor(recode(Smoke100,
                                     `1` = "Yes",
                                     `2` = "No")),
         Vegetables = as_factor(recode(Vegetables,
                                       `0` = "None",
                                       `1` = "1/2 cup or less",
                                       `2` = "1/2 to 1 cup",
                                       `3` = "1-2 cups",
                                       `4` = "2-3 cups",
                                       `5` = "3-4 cups",
                                       `6` = "4+ cups")))
```

Ignore the [map()](https://purrr.tidyverse.org/reference/map.html) and [mutate()](https://dplyr.tidyverse.org/reference/mutate.html) calls. Negative values are seemingly nulls, so I quickly recoded them so I could calculate statistics below. You'd have to check them more fully, of course!

```{r apply_weights}
hints_svy <- svydesign(ids = ~PersonID,
                       strata = ~Stratum,
                       #fpc = 5438,
                       weights = ~nwgt0,
                       data = hints)
```

First we have to create a [svydesign](http://r-survey.r-forge.r-project.org/survey/html/svydesign.html) object. HINTS' documentation lists the weights and other variables you need to use here. The survey implements different weighting methods, but I stuck with the basic weight that has all of the treatments applied. I'm not sure if finite population correction is necessary so I commented it out.

The weighted sample size is **252,070,495** which is an enormous change from the actual observations (`r nrow(hints)`).
```{r svytable_ex}
svytable(~TobaccoMessages_HESmoking + SmokeNow, hints_svy) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed",
                                      "responsive"))
```
(Interestingly, knowing that the government warns about the negative health effects of smoking doesn't seem to affect anything here.)

Survey objects must be used with a set of specific functions that all start with _svy._

The example above uses [svytable](https://www.rdocumentation.org/packages/survey/versions/4.0/topics/svytable) to create a contingency table.

* [svyquantile](https://www.rdocumentation.org/packages/survey/versions/4.0/topics/svyquantile)
* [svyVar](https://www.rdocumentation.org/packages/survey/versions/4.0/topics/svrVar)
* [svyttest](https://www.rdocumentation.org/packages/survey/versions/4.0/topics/svyttest)
* [svyglm](https://www.rdocumentation.org/packages/survey/versions/4.0/topics/svyglm)
* [svyplot](https://www.rdocumentation.org/packages/survey/versions/4.0/topics/svyplot)

Many other useful functions may be found [here](https://www.rdocumentation.org/packages/survey/versions/4.0).

```{r svyby_example}
svyby(~WeeklyMinutesModerateExercise, ~SmokeNow, hints_svy, svymean,
      na.rm = TRUE)
```
The function [svyby()](https://www.rdocumentation.org/packages/survey/versions/4.0/topics/svyby) is basically a group by plus applying a function.

```{r svyglm_example}
hints_svy <- hints_svy %>%
  update(Smoker = (SmokeNow == "Everyday") | (SmokeNow == "Some days"))

smoke_mod <- svyglm(DrinksPerDay ~ Vegetables + Smoker + IncomeFeelings +
                      HowLongModerateExerciseMinutes,
                    family = "poisson",
                    design = hints_svy)

tidy(smoke_mod, conf.int = TRUE, exponentiate = TRUE)
```

The [update()](https://cran.r-project.org/web/packages/survey/survey.pdf) functions works similarly to **mutate()** by allowing us to tidily create new variables for our survey design. Generalized linear models function similarly using the Survey package as they do in base R. The main difference is that you must use **svyglm()** over the base functions!
